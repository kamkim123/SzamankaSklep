<!doctype html>
<html lang="pl">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>

    {% load static %}

    {# --- SEO podstawowe --- #}
    <title>{{ product.product_name }} – Szamanka</title>

    <meta name="description"
          content="{% if product.short_description %}{{ product.short_description|striptags|truncatechars:155 }}{% elif product.product_info %}{{ product.product_info|striptags|truncatechars:155 }}{% else %}Naturalny produkt w sklepie Szamanka. Zobacz opis, skład i cenę.{% endif %}">

    <meta name="robots" content="index,follow">

    {# canonical: najlepiej bez query, czyli absolutny URL aktualnej strony #}
    <link rel="canonical" href="{{ request.build_absolute_uri|cut:request.get_full_path|add:request.path }}">

    {# --- Open Graph / social --- #}
    <meta property="og:locale" content="pl_PL">
    <meta property="og:type" content="product">
    <meta property="og:site_name" content="Szamanka">
    <meta property="og:title" content="{{ product.product_name }} – Szamanka">
    <meta property="og:description"
          content="{% if product.short_description %}{{ product.short_description|striptags|truncatechars:200 }}{% elif product.product_info %}{{ product.product_info|striptags|truncatechars:200 }}{% else %}Naturalny produkt w sklepie Szamanka.{% endif %}">
    <meta property="og:url" content="{{ request.build_absolute_uri }}">

    {# og:image: jeśli product_image jest pełnym URL to będzie OK; jeśli to ścieżka względna, podmień na pełny URL #}
    {% if product.product_image %}
      <meta property="og:image" content="{{ product.product_image }}">
    {% endif %}

    {# Twitter (opcjonalnie) #}
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{{ product.product_name }} – Szamanka">
    <meta name="twitter:description"
          content="{% if product.short_description %}{{ product.short_description|striptags|truncatechars:200 }}{% elif product.product_info %}{{ product.product_info|striptags|truncatechars:200 }}{% else %}Naturalny produkt w sklepie Szamanka.{% endif %}">
    {% if product.product_image %}
      <meta name="twitter:image" content="{{ product.product_image }}">
    {% endif %}

    {# --- (Opcjonalnie, ale mocno polecam) JSON-LD Product --- #}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Product",
      "name": "{{ product.product_name|escapejs }}",
      "description": "{{ product.short_description|default:product.product_info|default:'Naturalny produkt w sklepie Szamanka.'|striptags|truncatechars:500|escapejs }}",
      "sku": "{{ product.id }}",
      "offers": {
        "@type": "Offer",
        "priceCurrency": "PLN",
        "price": "{{ product.final_price|default:product.price|floatformat:2 }}",
        "availability": "https://schema.org/{% if product.product_stock|default:0 > 0 %}InStock{% else %}OutOfStock{% endif %}",
        "url": "{{ request.build_absolute_uri|escapejs }}"
      }
    }
    </script>

    {# --- Twoje istniejące zasoby --- #}
    <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="{% static 'products/detail.css' %}"/>
    <link rel="stylesheet" href="{% static 'products/navbar.css' %}">
    <link rel="stylesheet" href="{% static 'products/animations.css' %}">

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" crossorigin="anonymous"></script>

    <script>
        var cartAddUrl = "{% url 'orders:cart_add' %}";
    </script>
</head>

<body>

{% include "products/navbar.html" %}

<main class="one-product-page">
    <div class="container">
        <div class="breadcrumbs" aria-label="okruszki nawigacji">
            <a href="/">Home</a>
            <span aria-hidden="true">/</span>
            <a href="/products/">Produkty</a>
            <span aria-hidden="true">/</span>
            <span class="current">{{ product.category.name }}</span>
        </div>

        <section class="product-grid" aria-labelledby="product-title">
            <!-- LEWA KOLUMNA: GALERIA + OPIS POD ZDJĘCIEM -->
            <div class="left-col">
                <!-- GALERIA -->
                <div class="gallery-wrap">
                    <div class="image-card card">
                        {% if product.is_promotion %}
                          <span class="badge badge--promo">Promocja</span>
                        {% endif %}

                        <div class="image-wrapper2">
                            <img src="{{ product.product_image }}" alt="{{ product.product_name }}" class="main-image"/>
                            <div class="mini-photos" role="list" aria-label="Dodatkowe zdjęcia">
                                {% for img in product.gallery.all %}
                                <button class="mini-photo" type="button" role="listitem"
                                        aria-label="Pokaż zdjęcie {{ forloop.counter }}">
                                    <img src="{{ product.product_image }}" data-full="{{ product.product_image }}"
                                         alt="{{ product.product_name }} – miniatura {{ forloop.counter }}"/>
                                </button>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- OPIS PRODUKTU POD ZDJĘCIEM -->
                <div class="desc-wrap">
                    <article class="product-description card" id="opis">
                        <h2>Opis produktu</h2>
                        <div class="prose">
                            <p>
                                {{ product.product_info }}
                            </p>
                        </div>

                        <div class="meta-grid">
                            <div>
                                <span class="meta-label">Kategoria</span>
                                <span class="meta-value">{{ product.product_type }}</span>
                            </div>

                        </div>
                    </article>
                </div>
            </div>

            <!-- PRAWA KOLUMNA: INFORMACJE I CTA -->
            <div class="product-info card">

                <h1 id="product-title" class="product-name">{{ product.product_name }}</h1>
                <p class="product-short-desc">{{ product.short_description }}</p>

                <div class="price-row">
                  {% if product.has_promo %}
                    <span class="product-price product-price--promo">{{ product.final_price|floatformat:2 }} zł</span>
                    <span class="product-price-old">{{ product.price|floatformat:2 }} zł</span>
                    <span class="product-discount">-{{ product.discount_percent }}%</span>
                  {% else %}
                    <span class="product-price">{{ product.price|floatformat:2 }} zł</span>
                  {% endif %}
                </div>


                <div class="quantity">
                    <div class="calc-container" aria-label="Wybierz ilość" role="group">
                        <button class="minus" type="button" aria-label="Zmniejsz ilość">−</button>
                        <div class="calc-input" role="spinbutton" aria-valuemin="1" aria-valuenow="1"
                             aria-valuemax="99">01
                        </div>
                        <button class="plus" type="button" aria-label="Zwiększ ilość">+</button>
                    </div>

                    <form method="post" action="{% url 'orders:cart_add' %}" class="cart-form">
                        {% csrf_token %}
                        <input type="hidden" name="product_id" value="{{ product.id }}"/>
                        <input type="hidden" name="quantity" value="1"/>
                        <button class="cart" data-product-id="{{ product.id }}" type="submit">
                            <i class='bx bx-cart'></i> Dodaj do koszyka
                        </button>
                    </form>

                    {% if user.is_authenticated %}
                    {% if product in user.favorites.all %}
                    <span class="favorite-toggle active" data-product-id="{{ product.id }}">
            <i class="bx bxs-heart" aria-hidden="true"></i> Ulubione
        </span>
                    {% else %}
                    <span class="favorite-toggle" data-product-id="{{ product.id }}">
            <i class="bx bx-heart" aria-hidden="true"></i> Dodaj do ulubionych
        </span>
                    {% endif %}
                    {% else %}
                    <a href="{% url 'users:login' %}?next={{ request.path }}" class="favorite">
                        <i class="bx bx-heart" aria-hidden="true"></i> Zaloguj się aby dodać
                    </a>
                    {% endif %}


                </div>

                <div class="add-info-wrapper subtle">
                    <img src="{% static 'products/images/delivery-truck.png' %}" alt="Wysyłka" class="add-icon"/>
                    <div class="add-info">Wysyłka w ciągu 1–8 dni roboczych.</div>
                </div>

                <ul class="bullets">

                    <li><i class='bx bx-refresh'></i> 14 dni na zwrot</li>
                    <li><i class='bx bx-shield'></i> Gwarancja oryginalności</li>
                </ul>
            </div>
        </section>
    </div>
</main>

<!-- PODOBNE PRODUKTY -->
<section class="information-section">
    <div class="container">
        <h3 class="title">Podobne produkty</h3>
        <div class="diff-products-wrapper">
            {% if similar_products %}
            {% for p in similar_products %}
            <div class="diff-product">
                <a href="{% url 'products:detail' p.pk %}">
                    <img src="{{ p.product_image }}" alt="{{ p.product_name }}"/>
                    <h3>{{ p.product_name }}</h3>
                    {% if p.has_promo %}
                      <span class="price">
                        <strong>{{ p.final_price|floatformat:2 }} zł</strong>
                        <s class="price__old">{{ p.price|floatformat:2 }} zł</s>
                      </span>
                    {% else %}
                      <span class="price">{{ p.price|floatformat:2 }} zł</span>
                    {% endif %}
                </a>
            </div>
            {% endfor %}
            {% else %}
            <p>Brak podobnych produktów do wyświetlenia.</p>
            {% endif %}
        </div>
    </div>
</section>

{% include "products/footer.html" %}


<script src="{% static 'products/detail.js' %}"></script>



</body>
</html>
